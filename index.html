<script>
(() => {
  // ==== Base path para GitHub Pages (funciona en /dashboard-proyectos/) ====
  const BASE = location.pathname.endsWith('/')
    ? location.pathname
    : location.pathname.replace(/\/[^/]*$/, '/');

  // ==== Estado ====
  let rows = [];
  let chStatus = null, chOwner = null, chTipo = null;
  let curView = "todo";
  let curSort = { key: "deadline", dir: 1 };

  // ==== Referencias DOM ====
  const q     = document.getElementById("q");
  const fCli  = document.getElementById("f-cliente");
  const fProy = document.getElementById("f-proyecto");
  const fOwn  = document.getElementById("f-owner");
  const tbody = document.getElementById("tbody");
  const count = document.getElementById("count");
  const tabs  = [...document.querySelectorAll(".tab")];

  // ==== Utils ====
  const norm  = s => (s??"").toString().trim().toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g,"");
  const isDone= r => ["finalizado","finalizada","cerrado","completado","completada"].includes(norm(r.estatus));
  const uniq  = arr => [...new Set(arr.filter(Boolean))].sort((a,b)=>a.localeCompare(b,'es'));
  function fillSelect(sel, list, label){
    sel.innerHTML = `<option value="">${label} (todos)</option>` + uniq(list).map(v=>`<option value="${v}">${v}</option>`).join("");
  }

  // ==== KPIs ====
  function updateKPIs(data){
    const today = new Date(); today.setHours(0,0,0,0);
    const soonDays = 7*86400000;
    const done = data.filter(isDone).length;
    const late = data.filter(r=>!isDone(r) && r.deadline && new Date(r.deadline) < today).length;
    const soon = data.filter(r=>{
      if (isDone(r) || !r.deadline) return false;
      const diff = new Date(r.deadline) - today;
      return diff <= soonDays && diff >= 0;
    }).length;
    document.getElementById("kpi-total").textContent = data.length;
    document.getElementById("kpi-done").textContent  = done;
    document.getElementById("kpi-late").textContent  = late;
    document.getElementById("kpi-soon").textContent  = soon;
  }

  // ==== Vistas / Filtros ====
  function filtered(){
    const query = norm(q.value);
    const c = fCli.value, p=fProy.value, o=fOwn.value;
    const today = new Date(); today.setHours(0,0,0,0);
    const weekAhead = 14*86400000;

    return rows.filter(r=>{
      if (c && r.cliente !== c) return false;
      if (p && r.proyecto !== p) return false;
      if (o && r.owner    !== o) return false;

      if (query){
        const hay = [r.cliente,r.proyecto,r.tareas,r.estatus,r.owner].some(x=>norm(x).includes(query));
        if (!hay) return false;
      }

      const dl = r.deadline ? new Date(r.deadline) : null;
      const done = isDone(r);

      if (curView==="finalizadas") return done;

      if (curView==="urgentes"){
        if (done || !dl) return false;
        const diff = dl - today;
        return diff < 0 || diff <= weekAhead;
      }

      if (curView==="programadas"){
        if (done) return false;
        if (!dl) return true;
        const diff = dl - today;
        return diff > weekAhead;
      }

      return true;
    });
  }

  // ==== GrÃ¡ficos ====
  function renderCharts(data){
    const STATUS_COLORS = {
      "Finalizado": "#1f77b4",
      "Iniciado en Plazo": "#2ca02c",
      "No iniciado": "#ffbf00",
      "On Hold": "#ff7f0e",
      "Atrasado": "#d62728",
      "Otros": "#9e9e9e"
    };
    const today = new Date(); today.setHours(0,0,0,0);

    const bucketsStatus = { "Finalizado":0, "Iniciado en Plazo":0, "No iniciado":0, "On Hold":0, "Atrasado":0, "Otros":0 };
    data.forEach(r=>{
      const e = (r.estatus||"").trim();
      const t = norm(e);
      let cat = "Otros";
      if (["finalizado","finalizada","cerrado","completado","completada"].includes(t)) cat = "Finalizado";
      else if (t.includes("hold")) cat = "On Hold";
      else if (t==="iniciado" || t.includes("en plazo") || t.includes("plazo")) cat = "Iniciado en Plazo";
      else if (t.includes("no iniciado") || t.includes("pendiente")) cat = "No iniciado";
      else if (t.includes("atrasado")) cat = "Atrasado";
      if (cat!=="Finalizado" && r.deadline && new Date(r.deadline) < today) cat = "Atrasado";
      bucketsStatus[cat] = (bucketsStatus[cat]||0)+1;
    });
    const order = ["Finalizado","Iniciado en Plazo","No iniciado","On Hold","Atrasado","Otros"];
    const stLabels = order.filter(k=>bucketsStatus[k]>0);
    const stCounts = stLabels.map(k=>bucketsStatus[k]);
    const stColors = stLabels.map(k=>STATUS_COLORS[k] || "#999");

    if (chStatus) chStatus.destroy();
    chStatus = new Chart(document.getElementById("chStatus"), {
      type: "pie",
      data: { labels: stLabels, datasets: [{ data: stCounts, backgroundColor: stColors }] },
      options: { responsive:true, plugins:{ legend:{ position:"bottom" } } }
    });

    const byOwner = {};
    data.forEach(r=>{ const k = r.owner || "Sin owner"; byOwner[k] = (byOwner[k]||0)+1; });
    const owLabels = Object.keys(byOwner);
    const owCounts = owLabels.map(k=>byOwner[k]);
    if (chOwner) chOwner.destroy();
    chOwner = new Chart(document.getElementById("chOwner"), {
      type: "pie",
      data: { labels: owLabels, datasets: [{ data: owCounts }] },
      options: { responsive:true, plugins:{ legend:{ position:"bottom" } } }
    });

    const byTipo = {};
    data.forEach(r=>{ const k = r.tipo || "Sin tipo"; byTipo[k] = (byTipo[k]||0)+1; });
    const tpLabels = Object.keys(byTipo);
    const tpCounts = tpLabels.map(k=>byTipo[k]);
    if (chTipo) chTipo.destroy();
    chTipo = new Chart(document.getElementById("chTipo"), {
      type: "pie",
      data: { labels: tpLabels, datasets: [{ data: tpCounts }] },
      options: { responsive:true, plugins:{ legend:{ position:"bottom" } } }
    });
  }

  // ==== Tabla ====
  function render(){
    const data = filtered().sort((a,b)=>{
      const ka = a[curSort.key] ?? "";
      const kb = b[curSort.key] ?? "";
      if (curSort.key==="deadline"){
        const da = ka? new Date(ka).getTime(): 0;
        const db = kb? new Date(kb).getTime(): 0;
        return (da-db)*curSort.dir;
      }
      return ka.toString().localeCompare(kb.toString(),'es')*curSort.dir;
    });

    const today = new Date(); today.setHours(0,0,0,0);
    tbody.innerHTML = data.map(r=>{
      let color = "#111";
      const done = isDone(r);
      const dl   = r.deadline ? new Date(r.deadline) : null;
      if (done) color = "#16a34a";
      else if (dl && dl<today) color = "#dc2626";
      const fmt = dl ? dl.toLocaleDateString("es-CL") : "";
      return `<tr style="color:${color}">
        <td>${r.cliente||""}</td>
        <td>${r.proyecto||""}</td>
        <td>${r.tareas||""}</td>
        <td>${r.tipo||""}</td>
        <td>${r.estatus||""}</td>
        <td>${r.owner||""}</td>
        <td>${fmt}</td>
      </tr>`;
    }).join("");

    count.textContent = data.length + " filas";
    updateKPIs(rows);
    renderCharts(data);
  }

  // ==== Render principal (se llama al tener data) ====
  function renderDashboard(data){
    rows = Array.isArray(data) ? data : [];
    fillSelect(fCli, rows.map(r=>r.cliente), "Cliente");
    fillSelect(fProy, rows.map(r=>r.proyecto), "Proyecto");
    fillSelect(fOwn, rows.map(r=>r.owner), "Owner");
    render();
  }

  // ==== Eventos ====
  q.addEventListener("input", render);
  fCli.addEventListener("change", render);
  fProy.addEventListener("change", render);
  fOwn.addEventListener("change", render);

  document.querySelectorAll("th[data-sort]").forEach(th=>{
    th.style.cursor="pointer";
    th.addEventListener("click", ()=>{
      const k = th.dataset.sort;
      if (curSort.key===k) curSort.dir*=-1;
      else {curSort.key=k; curSort.dir=1;}
      render();
    });
  });

  tabs.forEach(btn=>btn.addEventListener("click", ()=>{
    tabs.forEach(b=>b.classList.remove("active"));
    btn.classList.add("active");
    curView = btn.dataset.view;
    render();
  }));

  // ==== Carga de datos con cache-busting ====
  async function loadData() {
    let cb = Date.now();
    try {
      const r = await fetch(`${BASE}cache-bust.txt`, { cache: 'no-store' });
      if (r.ok) cb = (await r.text()).trim();
    } catch {}
    const res = await fetch(`${BASE}data.json?cb=${encodeURIComponent(cb)}`, { cache: 'no-store' });
    const data = await res.json();
    renderDashboard(data);
  }

  loadData();
})();
</script>


</body>
</html>
